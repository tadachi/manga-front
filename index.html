<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Shadow DOMed -->
    <!-- Jquery -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js'></script>
    <!-- AngularJS -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.1/angular.min.js'></script>
    <!--<script src='https://code.angularjs.org/1.4.0-rc.2/angular.min.js'></script>-->
</head>
<script>
    var app = angular.module("App", []);

    app.controller("Ctrl", function($scope, $http, $q, $location) {

        //http://localhost:4000/manga/another_world_it_exists/v01/c001/001.jpg

        $scope.chapters = [];
        $scope.chapters_pages = [];
        $scope.pages = []; // [{page: 'Page 1', url: 'http://hostname/manga/manga_name/volume/chapter/001.jpg'}]
        $scope.selectedChapter = 'test';
        $scope.selectedPage;
        $scope.hostname = $location.absUrl(); // http://localhost:4000, http://beastmachine/, http://www.tak.com/
        $scope.src = "";
        $scope.url = $scope.hostname + 'manga_index/another_world_it_exists_index.json';

        $scope.getMangaIndex = function(url, callback) {
            $http.get(url).
                success(function(data) {
                    callback(data)
                }).
                error(function(data) {
                    callback(data);
                });
        };

        $scope.changeChapterPages = function(index) {
            // Reset pages and set to new chapter.
            $scope.pages = [];

            // Set it.
            if ($scope.chapters_pages[index]) {
                var i = 0;
                console.log($scope.chapters_pages[index]);
                angular.forEach($scope.chapters_pages[index]['images'], function(page_url) {
                    $scope.pages.push({page: 'Page ' + i, url: page_url});
                    i++;
                });
                console.log($scope.pages);
            }

            // Set default selected page.
            $scope.selectedPage = $scope.pages[0];

            // Set default src
            $scope.setImgSrc($scope.pages[0].url);
        };

        $scope.setImgSrc = function(url) {
            $scope.src = $scope.hostname + url;
        };

        $scope.getMangaIndexQ = function(url) {
            return $q(function(resolve, reject) {
                $http.get(url).
                    success(function(manga_index) {
                        resolve(manga_index)
                    }).
                    error(function(data) {
                        reject(data);
                    });
            });
        };

        $scope.setIndex = function(manga_index) {
            var i = 0;
            angular.forEach(manga_index, function(chapters, volume) { //value, key
                console.log(volume);
                console.log(chapters);
                angular.forEach(chapters, function(chapter, chapter_number) {
                    $scope.chapters.push({
                        title: volume.toUpperCase() + ' ' + chapter_number.toUpperCase() + ' - ' + chapter['title'],
                        index: i
                    });
                    $scope.chapters_pages.push( {
                        images: chapter['img'],
                        index: i
                    });
                    i++;
                })
            });

            // Set default selected chapter.
            $scope.selectedChapter = $scope.chapters[0];

            // Change page of selected chapter to first page.
            $scope.changeChapterPages(0);

            // Change the src
            $scope.setImgSrc($scope.pages[0].url);
        };

        $scope.script = function() {
            $scope.getMangaIndexQ($scope.url)
                .then( function(manga_index){
                    $scope.setIndex(manga_index);

                    return manga_index;
                })
                .then( function(manga_index) {

                })
        };

        angular.element(document).ready(function () {
            console.log('Hello World');
            console.log(angular.version);

            $scope.script();
//            $scope.getMangaIndex($scope.url, function(data) {
//                console.log(data);
//            });


        });

    });
</script>
<body>
<div id="header">
    <!-- Shadow DOMed -->
</div>
<div id="body">
    Body
    <div ng-app="App">
        <div ng-controller="Ctrl">
            <p>selected item is : {{selectedChapter.title}}</p>
            <p>selected item is : {{selectedPage.page}}</p>
            <!-- track by is a hack -->
            <select ng-model="selectedChapter"
                    ng-options="chapter.title for chapter in chapters track by chapter.title"
                    ng-change="changeChapterPages(selectedChapter.index)">
                <option value="" disabled> - Pick a Chapter - </option>
            </select>
            <select ng-model="selectedPage"
                    ng-options="page.page for page in pages"
                    ng-change="setImgSrc(selectedPage.url)"
                    >
                <option value="" disabled> - Pick a Page - </option>
            </select>
            <div id="image">
                <img ng-src="{{src}}" />
            </div>
        </div>
    </div>
</div>

<div id="footer">
    <!-- Shadow DOMed -->
</div>
</body>
</html>

<template id="headTemplate">
    <meta charset="utf-8">
    <title>stub</title>
    <meta name="description" content="App">
    <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
</template>

<template id="headerTemplate">
    Header
</template>

<template id="footerTemplate">
    Footer
</template>

<script>
    var shadow = document.head.createShadowRoot();
    var template = document.querySelector('#headTemplate');
    var templateClone = document.importNode(template.content, true);
    shadow.appendChild(templateClone);
</script>

<script>
    var shadow = document.querySelector("#header").createShadowRoot();
    var template = document.querySelector('#headerTemplate');
    var templateClone = document.importNode(template.content, true);
    shadow.appendChild(templateClone);
</script>

<script>
    var shadow = document.querySelector("#footer").createShadowRoot();
    var template = document.querySelector('#footerTemplate');
    var templateClone = document.importNode(template.content, true);
    shadow.appendChild(templateClone);
</script>